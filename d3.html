<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script
      src="https://www.unpkg.com/d3@7.0.1/dist/d3.min.js"
      type="text/javascript"
    ></script>

    <!-- <script src="https://d3js.org/d3.v6.js" type="text/javascript"></script> -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Red+Hat+Text&display=swap"
      rel="stylesheet"
    />
    <style type="text/css">
      h1 {
        font-family: "DM Serif Display", serif;
      }

      body {
        margin: 1rem;
        padding: 1rem;
        background-color: #fff6d5;
        font-size: 18px;
        font-family: "Red Hat Text", sans-serif;
        box-shadow: 2px 2px 24px -4px rgba(0, 0, 0, 0.59);
        text-align: center;
      }

      header {
        margin-left: 50px;
        display: flex;
        text-align: left;
      }

      .headerTextArea p {
        width: 750px;
        margin: 10px 0 0 0;
        padding: 0 80px 0 0;
      }

      footer {
        margin-top: 10px;
      }

      .category {
        clip-path: url(#clip);
      }

      .category:hover {
        fill: black;
      }

      .legends {
        margin-top: 33px;
      }

      #tooltipDate {
        background-color: #ecc633;
        margin: 0;
        padding: 10px;
      }

      #tooltipDetail {
        background-color: #faedbf;
        margin: 0;
        padding: 1px 10px 1px 10px;
      }

      #tooltip {
        visibility: hidden;
        position: absolute;
        text-align: left;
        width: auto;
        height: auto;
        font: 17px sans-serif;
        box-shadow: 2px 2px 24px -4px rgba(0, 0, 0, 0.59);
        pointer-events: none;
      }
    </style>
    <title>The Media Coverage of Inequality Topics</title>
  </head>
  <body>
    <header>
      <div class="headerTextArea">
        <h1>The Media Coverage of Inequality Topics</h1>
        <p>
          This website visualises the Media Coverage of Inequality Topics such
          as Education, Crime, Homeless, Poverty, and Unemploy from 2007 to 2021
          in Australia. It contains 953 days of data.
        </p>
        <p>Data Source: <a href="https://www.google.com">XXX Institution</a></p>
      </div>
      <div class="legends"></div>
    </header>
    <div class="canvas"></div>
    <!-- <footer>
      <table style="border: 1px solid">
        <tr style="border: 1px solid">
          <td style="border: 1px solid">Proportion</td>
          <td style="border: 1px solid">Trend</td>
          <td style="border: 1px solid">Data</td>
          <td style="border: 1px solid">Download</td>
          <td style="border: 1px solid">SourceCode</td>
          <td style="border: 1px solid">Full Screen</td>
        </tr>
      </table>
    </footer> -->
    <div id="tooltip">
      <div id="tooltipDate"></div>
      <div id="tooltipDetail"></div>
    </div>
    <script>
      const focusMargin = { top: 20, right: 20, bottom: 100, left: 20 };
      const contextMargin = { top: 370, right: 20, bottom: 20, left: 20 };
      const width = 960 - focusMargin.left - focusMargin.right;
      const focusHeight = 450 - focusMargin.top - focusMargin.bottom;
      const contextHeight = 450 - contextMargin.top - contextMargin.bottom;

      const parseTime = d3.timeParse("%Y-%m-%d");
      const formatTime = d3.timeFormat("%Y-%m-%d");

      const xScale = d3.scaleTime().range([0, width]);
      const yScale = d3.scaleLinear().range([focusHeight, 0]);
      const xScaleContext = d3.scaleTime().range([0, width]);

      const xAxis = d3
        .axisBottom(xScale)
        .ticks(width / 80)
        .tickSizeOuter(0);
      const yAxis = d3.axisLeft(yScale);
      const xAxisContext = d3.axisBottom(xScaleContext);

      const svg = d3
        .select(".canvas")
        .append("svg")
        // .attr("viewBox", [0, 0, 860, 480]);
        .attr("width", "960")
        .attr("height", "450");

      const brush = d3
        .brushX()
        .extent([
          [0, 0],
          [width, contextHeight],
        ])
        .on("brush", brushed);

      const zoom = d3
        .zoom()
        .scaleExtent([1, 32])
        .translateExtent([
          [0, 0],
          [width, focusHeight],
        ])
        .extent([
          [0, 0],
          [width, focusHeight],
        ])
        .on("zoom", zoomed);

      const focusArea = (x, y) =>
        d3
          .area()
          .curve(d3.curveMonotoneX)
          .x((d) => {
            // console.log(d.data.date);
            return x(d.data.date);
          })
          .y0((d) => y(d[0]))
          .y1((d) => y(d[1]));

      const contextArea = (x, y) =>
        d3
          .area()
          .x((d) => x(d.data.date))
          .y0(y(0))
          .y1((d) => y(d[1]));

      const clip = svg
        .append("defs")
        .append("clipPath")
        .attr("id", "clip")
        .append("rect")
        .attr("width", width)
        .attr("height", focusHeight);

      const legendSVG = d3
        .select(".legends")
        .append("svg")
        .attr("width", "100px")
        .attr("height", "90px");

      const focusSVG = svg
        .append("g")
        .attr("class", "focus")
        .attr(
          "transform",
          `translate(${focusMargin.left}, ${focusMargin.top})`
        );

      const contextSVG = svg
        .append("g")
        .attr("class", "context")
        .attr(
          "transform",
          `translate(${contextMargin.left}, ${contextMargin.top})`
        );

      d3.json("./data.json").then((rawData) => {
        /**
         * Restructure Raw Data, Parse Date
         */
        let data = [];
        for (const day in rawData) {
          //remove outliers
          // if (
          //   rawData[day]["education"] > 198 ||
          //   rawData[day]["crime"] > 32 ||
          //   rawData[day]["homeless"] > 12 ||
          //   rawData[day]["poverty"] > 13 ||
          //   rawData[day]["unemploy"] > 44
          // )
          //   continue;
          // if (rawData[day]["education"] <= 10) console.log(day);
          rawData[day].date = parseTime(day);
          data.push(rawData[day]);
        }
        //Sort Data by Dates
        data = data.sort((a, b) => d3.ascending(a.date, b.date));
        //Figure Out Keys
        const keys = ["education", "crime", "homeless", "poverty", "unemploy"];
        // const keys = Object.keys(rawData[Object.keys(rawData)[0]]).slice(0, 5);

        // //!!!!!!!!!!!!!!!!!!!!!Slice the data a little!!!!!!!!!!!!!!!!!!!!!!!!
        // data = data.splice(0, 2);
        // console.log(data);

        //Stack Data
        const series = d3
          .stack()
          .keys(keys)
          .order(d3.stackOrderInsideOut)
          .offset(d3.stackOffsetSilhouette)(data);
        console.log(series);

        const seriesRaw = d3.stack().keys(keys)(data);
        console.log(seriesRaw);

        //color
        const color = d3
          .scaleOrdinal()
          .domain(keys)
          .range(["#D17A22", "#157A6E", "#01BAEF", "#FF8CC6", "#9067C6"]);

        //domain management
        xScale.domain(d3.extent(data, (d) => d.date));
        yScale.domain([
          d3.min(series, (d) => d3.min(d, (d) => d[0])),
          d3.max(series, (d) => d3.max(d, (d) => d[1])),
        ]);
        xScaleContext.domain(d3.extent(data, (d) => d.date));

        /**
         * Render the SVG
         */

        focusSVG
          .selectAll("path")
          .data(series)
          .join("path")
          .attr("fill", ({ key }) => color(key))
          .attr("d", focusArea(xScale, yScale))
          .attr("class", "category")
          .append("title")
          .text((d) => d.key);

        focusSVG
          .append("g")
          .attr("class", "axis axis--x")
          .attr("transform", `translate(0,${focusHeight})`)
          .call(xAxis);

        // focusSVG.append("g").attr("class", "axis axis--y").call(yAxis);

        contextSVG
          .append("path")
          .datum(seriesRaw[4])
          .attr("fill", "black")
          .attr(
            "d",
            contextArea(xScaleContext, yScale.copy().range([contextHeight, 0]))
          )
          .attr("transform", `translate(0,${contextHeight / 2})`);

        contextSVG
          .append("g")
          .attr("class", "axis axis--x2")
          .attr("transform", `translate(0,${contextHeight})`)
          .call(xAxisContext);

        contextSVG
          .append("g")
          .attr("class", "brush")
          .call(brush)
          .call(brush.move, xScale.range());

        // Date Selector
        focusSVG
          .append("rect")
          .attr("class", "listeningRect")
          .attr("width", width)
          .attr("height", focusHeight)
          .attr("fill", "transparent")
          .on("mousemove", (event) => {
            const mousePosition = d3.pointer(event);
            const hoveredDate = formatTime(xScale.invert(mousePosition[0]));
            dataSelector.attr("fill", "black").attr("x", mousePosition[0]);

            if (rawData[hoveredDate]) {
              const arr = [];
              for (let key in rawData[hoveredDate]) {
                if (key !== "date")
                  arr.push(
                    `<p style="color:${color(key)}">${key}: ${
                      rawData[hoveredDate][key]
                    }</p>`
                  );
              }

              d3.select("#tooltip")
                .style("position", "absolute")
                .style("left", mousePosition[0] + 70 + "px")
                .style("top", mousePosition[1] + 110 + "px")
                .style("visibility", "visible");

              d3.select("#tooltipDate").text(hoveredDate);

              d3.select("#tooltipDetail").html(`${arr.join("")}`);
            }
          });

        focusSVG.call(zoom);

        const dataSelector = focusSVG
          .append("rect")
          .attr("class", "dotted")
          .attr("stroke-width", "1px")
          .attr("width", "3px")
          .attr("height", focusHeight)
          .attr("fill", "none");

        const legend = legendSVG
          .selectAll(".legend")
          .data(keys)
          .enter()
          .append("g")
          .attr("class", "legend")
          .attr("transform", function (d, i) {
            {
              return "translate(0," + i * 20 + ")";
            }
          });

        legend
          .append("rect")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", 10)
          .attr("height", 10)
          .style("fill", function (d, i) {
            return color(i);
          });
        legend
          .append("text")
          .attr("x", 20)
          .attr("y", 10)
          //.attr("dy", ".35em")
          .text(function (d, i) {
            return d;
          })
          .attr("class", "textselected")
          .style("text-anchor", "start")
          .style("font-size", 15);
      });

      function brushed({ sourceEvent, selection, type }) {
        if (sourceEvent && type === "zoom") return;
        xScale.domain(selection.map(xScaleContext.invert, xScaleContext));
        yScale.domain();
        focusSVG.selectAll(".category").attr("d", focusArea(xScale, yScale));
        focusSVG.select(".axis--x").call(xAxis);
      }

      function zoomed({ sourceEvent, type, transform }) {
        if (sourceEvent && type === "brush") return;
        focusSVG
          .selectAll(".category")
          .attr(
            "d",
            focusArea(transform.rescaleX(xScale), transform.rescaleY(yScale))
          );
        focusSVG.select(".axis--x").call(xAxis);
        // focusSVG.select(".axis--y").call(yAxis);
        contextSVG
          .select(".brush")
          .call(brush.move, xScale.range().map(transform.invertX, transform));
      }
    </script>
  </body>
</html>
